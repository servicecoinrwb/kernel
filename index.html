<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kernel Private Credit Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* CORE THEME OVERRIDES */
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        
        /* Force Card Text White */
        .card { background-color: #1e293b; border: 1px solid #334155; margin-bottom: 20px; color: #f8fafc; }
        
        /* Header Colors */
        .card-header { background-color: #334155; border-bottom: 1px solid #475569; font-weight: bold; color: white; }
        
        /* Fix the "text-muted" class to be visible on dark backgrounds */
        .text-muted { color: #cbd5e1 !important; }
        
        /* Ensure Labels are visible */
        label { color: #e2e8f0; font-weight: 500; }
        
        /* Buttons */
        .btn-primary { 
            background-color: #3b82f6; 
            border: none; 
            padding: 10px 20px; 
            font-weight: 600; 
            transition: all 0.3s ease;
        }
        .btn-primary:hover { 
            background-color: #2563eb; 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .btn-success { background-color: #10b981; border: none; transition: transform 0.2s; }
        .btn-success:hover { transform: translateY(-2px); }
        .btn-danger { background-color: #ef4444; border: none; transition: transform 0.2s; }
        .btn-danger:hover { transform: translateY(-2px); }
        .btn-outline-light:hover { color: #0f172a; background-color: white; }

        /* Input Fields */
        .form-control { background-color: #0f172a; border: 1px solid #334155; color: white; transition: border-color 0.3s, box-shadow 0.3s; }
        .form-control:focus { background-color: #0f172a; color: white; border-color: #3b82f6; box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25); }
        .form-control::placeholder { color: #64748b; } 

        /* Tabs */
        .nav-tabs { border-bottom: 1px solid #334155; }
        .nav-tabs .nav-link { color: #94a3b8; transition: all 0.3s ease; }
        .nav-tabs .nav-link:hover { border-color: #334155; color: #cbd5e1; }
        .nav-tabs .nav-link.active { background-color: #1e293b; color: #3b82f6; border-color: #334155 #334155 #1e293b; }
        
        /* Landing Page Specific Styles */
        .hero-section { padding: 100px 0; text-align: center; background: radial-gradient(circle at top, #1e293b 0%, #0f172a 70%); }
        .feature-icon { font-size: 2.5rem; margin-bottom: 1rem; color: #3b82f6; }
        .step-number { background: #3b82f6; color: white; width: 40px; height: 40px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; margin-bottom: 15px; }
        
        .glass-card { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.1); 
            transition: transform 0.4s ease, box-shadow 0.4s ease;
        }
        
        .glass-card:hover, .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
        }
        
        #dashboard-view { display: none; opacity: 0; transition: opacity 0.5s ease-in-out; } 
        #landing-view { transition: opacity 0.5s ease-in-out; }

        /* --- ANIMATIONS --- */
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate3d(0, 40px, 0);
            }
            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }

        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        .animate-up {
            animation: fadeInUp 0.8s ease-out forwards;
            opacity: 0; /* Start hidden for animation */
        }

        .pulse-btn {
            animation: pulse-glow 2s infinite;
        }

        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }
        .delay-300 { animation-delay: 0.3s; }
        .delay-400 { animation-delay: 0.4s; }
        .delay-500 { animation-delay: 0.5s; }

    </style>
</head>
<body>

<!-- LANDING PAGE VIEW -->
<div id="landing-view">
    <!-- Navbar -->
    <nav class="navbar navbar-dark bg-transparent pt-4 animate-up">
        <div class="container">
            <a class="navbar-brand fw-bold fs-3" href="#">Kernel <span class="text-primary">System</span></a>
            <button class="btn btn-outline-light" onclick="enterApp()">Launch App</button>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container">
            <h1 class="display-3 fw-bold mb-4 animate-up delay-100">Bridging On-Chain Liquidity<br>to Real World Yield</h1>
            <p class="lead text-muted mb-5 mx-auto animate-up delay-200" style="max-width: 700px;">
                A secure, compliant, and transparent private credit protocol. 
                Deposit USDC, fund whitelisted borrowers, and earn institutional-grade yields.
            </p>
            <div class="d-flex justify-content-center gap-3 animate-up delay-300">
                <button class="btn btn-primary btn-lg px-5 pulse-btn" onclick="enterApp()">Enter Dashboard <i class="fas fa-arrow-right ms-2"></i></button>
                <a href="#get-whitelisted" class="btn btn-outline-secondary btn-lg px-5 text-white">Join Whitelist</a>
            </div>
        </div>
    </section>

    <!-- Stats Banner -->
    <div class="container mb-5">
        <div class="row g-4 justify-content-center">
            <div class="col-md-3 animate-up delay-300">
                <div class="p-4 rounded glass-card text-center">
                    <h2 class="text-primary fw-bold">$2.4M+</h2>
                    <p class="text-muted mb-0">Total Value Locked</p>
                </div>
            </div>
            <div class="col-md-3 animate-up delay-400">
                <div class="p-4 rounded glass-card text-center">
                    <h2 class="text-success fw-bold">12.5%</h2>
                    <p class="text-muted mb-0">Average APY</p>
                </div>
            </div>
            <div class="col-md-3 animate-up delay-500">
                <div class="p-4 rounded glass-card text-center">
                    <h2 class="text-info fw-bold">0%</h2>
                    <p class="text-muted mb-0">Default Rate</p>
                </div>
            </div>
        </div>
    </div>

    <!-- How It Works -->
    <section id="how-it-works" class="py-5 bg-dark bg-opacity-50">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="fw-bold">How Kernel Works</h2>
                <p class="text-muted">A streamlined process for secure capital deployment.</p>
            </div>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card h-100 border-0 glass-card p-4">
                        <div class="text-center">
                            <div class="step-number">1</div>
                            <h4>Deposit</h4>
                            <p class="text-muted">Investors deposit USDC into the secure Vault. In return, they receive Kernel Shares representing their claim on the pool.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 glass-card p-4">
                        <div class="text-center">
                            <div class="step-number">2</div>
                            <h4>Lend</h4>
                            <p class="text-muted">The Kernel Admin (Underwriter) deploys capital to whitelisted Solvers (Borrowers) for real-world business activities.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 glass-card p-4">
                        <div class="text-center">
                            <div class="step-number">3</div>
                            <h4>Earn</h4>
                            <p class="text-muted">Solvers repay loans with interest. Fees are automatically split between the Protocol Treasury and Vault LPs.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Get Whitelisted Section -->
    <section id="get-whitelisted" class="py-5">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h2 class="fw-bold mb-4">How to Get Whitelisted</h2>
                    <p class="lead text-muted mb-4">
                        Kernel operates as a compliant, permissioned protocol. Access is restricted to qualified investors and vetted borrowers to ensure regulatory adherence and credit quality.
                    </p>
                    <div class="d-flex flex-column gap-4">
                        <div class="d-flex">
                            <div class="me-3">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <i class="fas fa-file-contract"></i>
                                </div>
                            </div>
                            <div>
                                <h5>1. Compliance & KYC</h5>
                                <p class="text-muted mb-0">Submit required Know-Your-Customer (KYC) or Know-Your-Business (KYB) documentation for verification.</p>
                            </div>
                        </div>
                        <div class="d-flex">
                            <div class="me-3">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <i class="fas fa-handshake"></i>
                                </div>
                            </div>
                            <div>
                                <h5>2. Legal Onboarding</h5>
                                <p class="text-muted mb-0">Sign off-chain Master Loan Agreements (for Solvers) or Subscription Agreements (for Investors).</p>
                            </div>
                        </div>
                        <div class="d-flex">
                            <div class="me-3">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <i class="fas fa-key"></i>
                                </div>
                            </div>
                            <div>
                                <h5>3. Protocol Activation</h5>
                                <p class="text-muted mb-0">Once approved, your wallet address is whitelisted by the Admin, granting you access to the dashboard.</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <!-- Updated Button to Trigger Modal -->
                        <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#onboardingModal">Start Onboarding Application</button>
                    </div>
                </div>
                <div class="col-lg-6 mt-5 mt-lg-0 text-center">
                    <div class="p-5 rounded glass-card border border-primary border-opacity-25">
                        <i class="fas fa-shield-alt text-primary mb-3" style="font-size: 4rem;"></i>
                        <h3>Secure & Compliant</h3>
                        <p class="text-muted">Our whitelist architecture ensures that all participants are known entities, protecting the liquidity pool from illicit funds and bad actors.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="py-4 mt-5 border-top border-secondary">
        <div class="container text-center text-muted">
            <p>&copy; 2024 Kernel System V1. All rights reserved.</p>
            <small>Audited Smart Contracts | Regulatory Compliant | Whitelist Only</small>
        </div>
    </footer>
</div>

<!-- DASHBOARD VIEW (Hidden Initially) -->
<div id="dashboard-view" class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4 animate-up">
        <div>
            <button class="btn btn-sm btn-outline-secondary mb-2" onclick="exitApp()"><i class="fas fa-arrow-left"></i> Back to Home</button>
            <h2>Kernel <span class="text-primary">System V1</span></h2>
        </div>
        <div>
            <span id="walletAddress" class="me-2 text-white">Not Connected</span>
            <button id="connectBtn" class="btn btn-primary pulse-btn" onclick="connectWallet()">Connect Wallet</button>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4 animate-up delay-100">
            <div class="card p-3 text-center">
                <small class="text-muted">Total Managed Assets (USDC)</small>
                <h3 id="totalAssets">0.00</h3>
            </div>
        </div>
        <div class="col-md-4 animate-up delay-200">
            <div class="card p-3 text-center">
                <small class="text-muted">Total Shares Minted</small>
                <h3 id="totalShares">0.00</h3>
            </div>
        </div>
        <div class="col-md-4 animate-up delay-300">
            <div class="card p-3 text-center">
                <small class="text-muted">Your Share Balance</small>
                <h3 id="userShares">0.00</h3>
            </div>
        </div>
    </div>

    <div class="animate-up delay-400">
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="investor-tab" data-bs-toggle="tab" data-bs-target="#investor" type="button">Investor Zone</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin" type="button">Admin Control</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="solver-tab" data-bs-toggle="tab" data-bs-target="#solver" type="button">Solver Interface</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            
            <div class="tab-pane fade show active" id="investor">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Deposit USDC</div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label>Amount (USDC)</label>
                                    <input type="number" id="depositAmount" class="form-control" placeholder="1000">
                                </div>
                                <button class="btn btn-warning w-100 mb-2" onclick="approveUSDC()">1. Approve USDC</button>
                                <button class="btn btn-success w-100" onclick="deposit()">2. Deposit Funds</button>
                                <small class="text-muted d-block mt-2">*Requires Whitelist</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Withdraw USDC</div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label>Share Amount to Burn</label>
                                    <input type="number" id="withdrawAmount" class="form-control" placeholder="500">
                                </div>
                                <button class="btn btn-danger w-100" onclick="withdraw()">Withdraw Funds</button>
                                <small class="text-muted d-block mt-2">*Subject to 24h Lockup</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="admin">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Vault Access Control</div>
                            <div class="card-body">
                                <label class="mb-2">Whitelist Investor Address</label>
                                <div class="input-group mb-3">
                                    <input type="text" id="whitelistAddress" class="form-control" placeholder="0x...">
                                    <button class="btn btn-primary" onclick="whitelistInvestor()">Whitelist</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Kernel Lending (Deploy Capital)</div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <label>Solver Address</label>
                                    <input type="text" id="loanSolver" class="form-control" placeholder="0x...">
                                </div>
                                <div class="mb-3">
                                    <label>Amount (USDC)</label>
                                    <input type="number" id="loanAmount" class="form-control" placeholder="50000">
                                </div>
                                <button class="btn btn-danger w-100" onclick="deployCapital()">Deploy Capital</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">Kernel Configuration</div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="mb-2">Whitelist Solver (Kernel)</label>
                                        <div class="input-group">
                                            <input type="text" id="solverWhitelistAddr" class="form-control" placeholder="0x...">
                                            <button class="btn btn-warning" onclick="whitelistSolver()">Add Solver</button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="mb-2">Set Treasury (Owner Only)</label>
                                        <div class="input-group">
                                            <input type="text" id="treasuryAddr" class="form-control" placeholder="0x...">
                                            <button class="btn btn-secondary" onclick="setTreasury()">Set</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="solver">
                <div class="card">
                    <div class="card-header">Repay Loan</div>
                    <div class="card-body">
                        <div class="alert alert-info" style="background-color: #0ea5e9; border-color: #0284c7; color: #fff;">Note: You must Approve the Kernel to spend your USDC before repaying.</div>
                        <div class="row">
                            <div class="col-md-6">
                                <label>Principal Amount</label>
                                <input type="number" id="repayPrincipal" class="form-control" placeholder="10000">
                            </div>
                            <div class="col-md-6">
                                <label>Profit/Fee Amount</label>
                                <input type="number" id="repayFee" class="form-control" placeholder="500">
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-warning" onclick="approveKernelUSDC()">1. Approve Kernel</button>
                            <button class="btn btn-success" onclick="repayLoan()">2. Repay Loan</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- SYSTEM FEATURES GUIDE (Visible inside App) -->
    <div class="mt-5 animate-up delay-500">
        <h4 class="mb-4 text-white">Dashboard Controls</h4>
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-transparent border-secondary text-primary">
                        Investor Zone
                    </div>
                    <div class="card-body">
                        <small class="text-muted">Use this to manage your position.</small>
                        <ul class="list-unstyled mt-2">
                            <li><i class="fas fa-check text-success me-2"></i>Deposit USDC</li>
                            <li><i class="fas fa-check text-success me-2"></i>Track Share Price</li>
                            <li><i class="fas fa-check text-success me-2"></i>Withdraw Liquidity</li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- Additional help cards can go here -->
        </div>
    </div>
</div>

<!-- ONBOARDING MODAL -->
<div class="modal fade" id="onboardingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="background-color: #1e293b; color: #f8fafc; border: 1px solid #334155;">
        <div class="modal-header" style="border-bottom: 1px solid #334155;">
          <h5 class="modal-title">KYC/KYB Application</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="onboardingForm">
              <div class="mb-3">
                  <label class="form-label">Legal Entity Name / Individual Name</label>
                  <input type="text" class="form-control" id="entityName" name="name" placeholder="e.g. Acme Corp LLC">
              </div>
              <div class="mb-3">
                  <label class="form-label">Contact Email</label>
                  <input type="email" class="form-control" id="contactEmail" name="email" placeholder="compliance@example.com">
              </div>
              <div class="mb-3">
                  <label class="form-label">Wallet Address to Whitelist</label>
                  <input type="text" class="form-control" id="kycWalletAddress" name="wallet" placeholder="0x...">
              </div>
              <div class="mb-3">
                <label class="form-label">Type of Participant</label>
                <select class="form-select" id="participantType" name="type" style="background-color: #0f172a; color: white; border: 1px solid #334155;">
                    <option value="Investor">Investor (Liquidity Provider)</option>
                    <option value="Solver">Solver (Borrower)</option>
                </select>
            </div>
              <div class="mb-3 form-check">
                  <input type="checkbox" class="form-check-input" id="termsCheck">
                  <label class="form-check-label text-muted" for="termsCheck" style="font-size: 0.9em;">I agree to the Terms of Service & Privacy Policy.</label>
              </div>
          </form>
        </div>
        <div class="modal-footer" style="border-top: 1px solid #334155;">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="submitOnboarding()">Submit Application</button>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

<script>
    // --- CONFIGURATION ---
    const VAULT_ADDRESS = "0x663D88dA87f6A4E8A9CD6A51C9aA5bC1A49e7d33";
    const KERNEL_ADDRESS = "0x4f707E4cAfCdb4458E7bB200CcBfbb888e64037f";
    // *** FORMSPREE CONFIG ***
    const FORMSPREE_ENDPOINT = "https://formspree.io/f/xzzlrnwg";

    // --- VIEW NAVIGATION ---
    function enterApp() {
        const landing = document.getElementById('landing-view');
        const dashboard = document.getElementById('dashboard-view');
        
        // Simple Fade Out/In
        landing.style.opacity = '0';
        setTimeout(() => {
            landing.style.display = 'none';
            dashboard.style.display = 'block';
            // Trigger Fade In
            setTimeout(() => { dashboard.style.opacity = '1'; }, 50);
        }, 500); // Wait for transition
    }

    function exitApp() {
        const landing = document.getElementById('landing-view');
        const dashboard = document.getElementById('dashboard-view');
        
        dashboard.style.opacity = '0';
        setTimeout(() => {
            dashboard.style.display = 'none';
            landing.style.display = 'block';
            setTimeout(() => { landing.style.opacity = '1'; }, 50);
        }, 500);
    }

    // --- ONBOARDING LOGIC (Formspree AJAX) ---
    function submitOnboarding() {
        // 1. Get Elements
        const modalEl = document.getElementById('onboardingModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        
        // 2. Validate Terms
        const terms = document.getElementById('termsCheck').checked;
        if(!terms) {
            alert("Please accept the Terms & Conditions.");
            return;
        }

        // 3. Gather Data
        const name = document.getElementById('entityName').value;
        const email = document.getElementById('contactEmail').value;
        const wallet = document.getElementById('kycWalletAddress').value;
        const type = document.getElementById('participantType').value;

        // 4. Construct Payload (Optimized for Formspree)
        const data = {
            name: name,                
            email: email,              
            _replyto: email,           
            _subject: `New Kernel KYC Application: ${name}`,
            message: `
            APPLICATION DETAILS
            -------------------
            Entity Name: ${name}
            Wallet Address: ${wallet}
            Participant Type: ${type}
            Terms Accepted: Yes
            `,
            // Custom Fields
            participant_type: type,
            wallet_address: wallet
        };

        // 5. Send to Formspree
        const submitBtn = document.querySelector('#onboardingModal .btn-primary');
        const originalText = submitBtn.innerText;
        submitBtn.innerText = "Sending...";
        submitBtn.disabled = true;

        fetch(FORMSPREE_ENDPOINT, {
            method: 'POST',
            body: JSON.stringify(data),
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        }).then(response => {
            submitBtn.innerText = originalText;
            submitBtn.disabled = false;
            
            if (response.ok) {
                modal.hide();
                alert("Success! Your application has been sent to our compliance team.");
                document.getElementById('onboardingForm').reset();
            } else {
                response.json().then(data => {
                    if (Object.hasOwn(data, 'errors')) {
                        const messages = data["errors"].map(error => error["message"]).join(", ");
                        alert("Submission Error: " + messages);
                    } else {
                        alert("Oops! There was a problem submitting your form (Generic Error).");
                    }
                })
            }
        }).catch(error => {
            console.error(error);
            submitBtn.innerText = originalText;
            submitBtn.disabled = false;
            alert("Network Error: Could not reach Formspree servers. Check your internet connection.");
        });
    }

    // ABIs (Simplified for Frontend interaction)
    const ERC20_ABI = [
        "function approve(address spender, uint256 amount) external returns (bool)",
        "function decimals() view returns (uint8)",
        "function balanceOf(address account) view returns (uint256)"
    ];

    const VAULT_ABI = [
        "function deposit(uint256 amount, uint256 minShares) external",
        "function withdraw(uint256 shareAmount, uint256 minAssets) external",
        "function totalManagedAssets() view returns (uint256)",
        "function totalShares() view returns (uint256)",
        "function shares(address) view returns (uint256)",
        "function usdc() view returns (address)",
        "function setInvestorStatus(address investor, bool status) external",
        "function isWhitelisted(address) view returns (bool)"
    ];

    const KERNEL_ABI = [
        "function deployCapital(address solver, uint256 amount) external",
        "function repayLoan(uint256 principal, uint256 fee) external",
        "function setSolver(address solver, bool status) external",
        "function setTreasury(address _treasury) external"
    ];

    // --- STATE ---
    let provider, signer, vaultContract, kernelContract, usdcContract;
    let userAddress;
    let usdcDecimals = 6; // Default to 6 for USDC

    async function connectWallet() {
        if (window.ethereum) {
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                
                document.getElementById("walletAddress").innerText = userAddress.substring(0,6) + "..." + userAddress.substring(38);
                document.getElementById("connectBtn").innerText = "Connected";
                document.getElementById("connectBtn").classList.replace("btn-primary", "btn-success");
                document.getElementById("connectBtn").classList.remove("pulse-btn"); // Stop pulsing on connect

                // Auto-fill modal address if connected
                document.getElementById("kycWalletAddress").value = userAddress;

                initContracts();
            } catch (error) {
                console.error(error);
                alert("Connection failed!");
            }
        } else {
            alert("Please install Metamask!");
        }
    }

    async function initContracts() {
        vaultContract = new ethers.Contract(VAULT_ADDRESS, VAULT_ABI, signer);
        kernelContract = new ethers.Contract(KERNEL_ADDRESS, KERNEL_ABI, signer);

        // Fetch USDC Address from Vault
        try {
            const usdcAddress = await vaultContract.usdc();
            usdcContract = new ethers.Contract(usdcAddress, ERC20_ABI, signer);
            usdcDecimals = await usdcContract.decimals();
            refreshData();
        } catch (e) {
            console.error("Error fetching USDC:", e);
            alert("Ensure you are on the correct network!");
        }
    }

    async function refreshData() {
        if(!vaultContract) return;
        
        try {
            const totalAssets = await vaultContract.totalManagedAssets();
            const totShares = await vaultContract.totalShares();
            const myShares = await vaultContract.shares(userAddress);

            document.getElementById("totalAssets").innerText = ethers.formatUnits(totalAssets, usdcDecimals);
            document.getElementById("totalShares").innerText = ethers.formatUnits(totShares, usdcDecimals); 
            document.getElementById("userShares").innerText = ethers.formatUnits(myShares, usdcDecimals);
        } catch(e) {
            console.error("Error fetching data", e);
        }
    }

    // --- INVESTOR ACTIONS ---

    async function approveUSDC() {
        try {
            const amount = ethers.parseUnits("1000000000", usdcDecimals); // Approve large amount
            const tx = await usdcContract.approve(VAULT_ADDRESS, amount);
            await tx.wait();
            alert("USDC Approved for Vault!");
        } catch (e) { alert("Approval failed: " + e.message); }
    }

    async function deposit() {
        try {
            const val = document.getElementById("depositAmount").value;
            const amount = ethers.parseUnits(val, usdcDecimals);
            // Slippage: Passing 0 for minShares in demo. In prod, calculate e.g. 99% of expected.
            const tx = await vaultContract.deposit(amount, 0); 
            await tx.wait();
            alert("Deposit Successful!");
            refreshData();
        } catch (e) { alert("Deposit failed (Are you whitelisted?): " + e.message); }
    }

    async function withdraw() {
        try {
            const val = document.getElementById("withdrawAmount").value;
            const shares = ethers.parseUnits(val, usdcDecimals);
            const tx = await vaultContract.withdraw(shares, 0);
            await tx.wait();
            alert("Withdrawal Successful!");
            refreshData();
        } catch (e) { alert("Withdraw failed (Lockup active?): " + e.message); }
    }

    // --- ADMIN ACTIONS ---

    async function whitelistInvestor() {
        try {
            const addr = document.getElementById("whitelistAddress").value;
            const tx = await vaultContract.setInvestorStatus(addr, true);
            await tx.wait();
            alert("Investor Whitelisted!");
        } catch (e) { alert("Action failed: " + e.message); }
    }

    async function deployCapital() {
        try {
            const solver = document.getElementById("loanSolver").value;
            const val = document.getElementById("loanAmount").value;
            const amount = ethers.parseUnits(val, usdcDecimals);
            const tx = await kernelContract.deployCapital(solver, amount);
            await tx.wait();
            alert("Capital Deployed to Solver!");
            refreshData();
        } catch (e) { alert("Deploy failed: " + e.message); }
    }

    async function whitelistSolver() {
        try {
            const addr = document.getElementById("solverWhitelistAddr").value;
            const tx = await kernelContract.setSolver(addr, true);
            await tx.wait();
            alert("Solver Whitelisted in Kernel!");
        } catch (e) { alert("Action failed: " + e.message); }
    }

    async function setTreasury() {
        try {
            const addr = document.getElementById("treasuryAddr").value;
            const tx = await kernelContract.setTreasury(addr);
            await tx.wait();
            alert("Treasury Updated!");
        } catch (e) { alert("Action failed: " + e.message); }
    }

    // --- SOLVER ACTIONS ---

    async function approveKernelUSDC() {
        try {
            const amount = ethers.parseUnits("1000000000", usdcDecimals);
            const tx = await usdcContract.approve(KERNEL_ADDRESS, amount);
            await tx.wait();
            alert("USDC Approved for Kernel!");
        } catch (e) { alert("Approval failed: " + e.message); }
    }

    async function repayLoan() {
        try {
            const pVal = document.getElementById("repayPrincipal").value;
            const fVal = document.getElementById("repayFee").value;
            const principal = ethers.parseUnits(pVal, usdcDecimals);
            const fee = ethers.parseUnits(fVal, usdcDecimals);
            
            const tx = await kernelContract.repayLoan(principal, fee);
            await tx.wait();
            alert("Loan Repaid!");
            refreshData();
        } catch (e) { alert("Repay failed: " + e.message); }
    }

</script>

</body>
</html>
